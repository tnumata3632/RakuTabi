<script>
$(window).load(function() {
  $('.flexslider').flexslider({
    animation: "slide",
    animationLoop: true,
    controlNav: false,
    start : function(slider){
      setActive(slider.currentSlide);
    },
    after : function(slider){
      setActive(slider.currentSlide);
    },
  });
});
</script>

<%= content_for(:header_for_google) do %>
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0 }
  #map_canvas { height: 100% }
</style>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=<%= ENV["GOOGLE_APPID"] %>&sensor=false">
</script>
<script type="text/javascript">
  var markerList;
  var iconActive;
  var iconInactive;
  function initialize() {
    markerList = new google.maps.MVCArray();
    var styles = [{"featureType":"landscape","stylers":[{"saturation":-100},{"lightness":65},{"visibility":"on"}]},{"featureType":"poi","stylers":[{"saturation":-100},{"lightness":51},{"visibility":"simplified"}]},{"featureType":"road.highway","stylers":[{"saturation":-100},{"visibility":"simplified"}]},{"featureType":"road.arterial","stylers":[{"saturation":-100},{"lightness":30},{"visibility":"on"}]},{"featureType":"road.local","stylers":[{"saturation":-100},{"lightness":40},{"visibility":"on"}]},{"featureType":"transit","stylers":[{"saturation":-100},{"visibility":"simplified"}]},{"featureType":"administrative.province","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"labels","stylers":[{"visibility":"on"},{"lightness":-25},{"saturation":-100}]},{"featureType":"water","elementType":"geometry","stylers":[{"hue":"#ffff00"},{"lightness":-25},{"saturation":-97}]}];
    var mapOptions = {
      center: new google.maps.LatLng(15.000, 155.000),
      zoom: 2,
      disableDefaultUI: true,
      zoomControl: true,
      zoomControlOptions: {
        position: google.maps.ControlPosition.TOP_RIGHT
      },
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      styles: styles
    };
    var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
    
    iconActive = new google.maps.MarkerImage('assets/pin_a.png',
      new google.maps.Size(50,79),
      new google.maps.Point(0,0),
      new google.maps.Point(14,46)
    );
    iconInactive = new google.maps.MarkerImage('assets/pin_ia.png',
      new google.maps.Size(50,79),
      new google.maps.Point(0,0),
      new google.maps.Point(14,46)
    );
    <% @counter = 0 %>
    <% @tours.each do |item| %>
      <% if ! item['img'].empty? %>
        <% @counter += 1 %>
        <% @lat = item['dest']['lat'] %>
        <% @lng = item['dest']['lng'] %>
        <% @name = item['dest']['name'] %>
    setTimeout(function() {
      var myLatLng = new google.maps.LatLng(<%= @lat %>,<%= @lng %>);
      var zindex = <%= @counter-1 %>;
      var marker = new google.maps.Marker({
        position: myLatLng, map: map, icon: iconInactive, title: '<%= @name %>', animation: google.maps.Animation.DROP, zIndex: zindex
      });
      markerList.push(marker);
      google.maps.event.addListener(marker, 'click', function(){
        $('.flexslider').flexslider(marker.getZIndex());
        markerList.forEach(function(marker){
          marker.setIcon(iconInactive);
        });
        marker.setIcon(iconActive);
      });
    }, <%= @counter %> * 180);
      <% end %>
    <% end %>
  }

  function setActive(current) {
    markerList.forEach(function(marker){
      marker.setIcon(iconInactive);
      if (marker.getZIndex() == current) marker.setIcon(iconActive);
    });
  }

  google.maps.event.addDomListener(window, 'load', initialize);
</script>
<% end %>

<% if ! @tours.nil? %>
  <div class="wrapper"><div class="flexslider"><ul class="slides">

    <% @tours.each do |item| %>
      <% if ! item['img'].empty? %>

        <!-- データを変数に格納 -->
        <% item['img'].sample(1).each do |img| %>
          <% @img_url = img['l'] %>
          <% @caption = img['caption'] %>
        <% end %>

        <% @tour_url = item['urls']['pc'] %>
        <% @title = item['title'] %>
        <% @city = item['city_summary'] %>

        <!-- HTMLで出力 -->
        <li>
          <div class="tour">
            <div class="pic">
            <%= link_to image_tag(@img_url, :alt => @caption), "/detail?tourid=" + item['id'], {data: {no_turbolink: true}} %>
            </div>
            <div class="text">
              <h2><%= @city %></h2>
              <%= @title %><br />
              <br />
              <%= link_to '> 詳細をみる', @tour_url, {:target => "_blank"} %>
            </div>
          </div>
        </li>

      <% end %>
    <% end %>

  <ul></div> </div>
<% end %>

<div style="height: 360px; width: 966px; margin: -54px auto 100px auto;">
  <div id="map_canvas" style="width:100%; height:100%"></div>
</div>
